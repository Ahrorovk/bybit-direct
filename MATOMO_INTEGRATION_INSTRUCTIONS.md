# Инструкция по интеграции Matomo Tag Manager в WebView

## Обзор

Данная инструкция описывает процесс интеграции Matomo Tag Manager в Android WebView приложение для отслеживания аналитики сайта `athletic-store.ru`.

## Что было реализовано

### 1. Интеграция Matomo Tag Manager
- Инъекция контейнера JavaScript через WebView
- Автоматическая инициализация Matomo после загрузки страницы
- Поддержка динамических элементов (SPA, React, Vue)

### 2. Передаваемые данные

#### Стандартные данные:
- ✅ URL страниц и заголовки
- ✅ Реферер
- ✅ User-Agent
- ✅ Cookies (настроен CookieManager)

#### Кастомные данные (Custom Dimensions):
- ✅ **Разрешение экрана** (Custom Dimension 1)
- ✅ **Модель устройства** (Custom Dimension 2)
- ✅ **Тип соединения** (Wi-Fi, 4G/5G) (Custom Dimension 3)
- ✅ **Версия приложения** (Custom Dimension 4)
- ✅ **User ID** (уникальный идентификатор пользователя, сохраняется локально)

### 3. Отслеживание событий (Events)

Реализовано автоматическое отслеживание:
- ✅ Клики по фильтрам (элементы с `data-filter`, классом `filter` и т.д.)
- ✅ Клики по кнопкам поиска
- ✅ Клики по всем кнопкам
- ✅ Изменения в формах (select, checkbox, radio)
- ✅ Поддержка динамических элементов через делегирование событий
- ✅ Отслеживание изменений роутера для SPA приложений

## Настройка в Matomo Tag Manager

### Шаг 1: Получение ID контейнера

1. Войдите в Matomo Tag Manager: `https://matomo.private-analytic-tools.com`
2. Выберите сайт `athletic-store.ru`
3. Выберите контейнер (например, "КОНТЕЙНЕР TESTWEBVIEW (HNSAYDRE)")
4. Скопируйте **Container ID** (например: `HNSAYDRE`)

### Шаг 2: Настройка тегов в Matomo Tag Manager

#### Тег для отслеживания событий кликов по фильтрам:

1. Перейдите в раздел **Теги** → **Создать новый тег**
2. Выберите тип: **Matomo Аналитика**
3. Настройки:
   - **Имя**: `Matomo Аналитика - клик по фильтру`
   - **Тип отслеживания**: `Событие`
   - **Категория события**: `Filter`
   - **Действие события**: `Click`
   - **Имя события**: `{{Event Name}}` (переменная из триггера)

4. **Триггер**: Создайте новый триггер
   - **Тип**: `Клик на любой элемент`
   - **Условие**: Элемент содержит `data-filter` ИЛИ класс содержит `filter`
   - **Переменная**: Создайте переменную `Event Name` для получения названия фильтра

#### Тег для отслеживания кликов по кнопке поиска:

1. Создайте новый тег типа **Matomo Аналитика**
2. Настройки:
   - **Имя**: `Matomo Аналитика - клик по кнопке поиска`
   - **Тип отслеживания**: `Событие`
   - **Категория**: `Search`
   - **Действие**: `Click`
   - **Имя**: `{{Search Query}}` или `search_button`

3. **Триггер**: 
   - **Тип**: `Клик на любой элемент`
   - **Условие**: Элемент `button[type="submit"]` ИЛИ содержит `data-action="search"`

#### Пример настройки триггера для фильтров:

```
Тип триггера: Клик на любой элемент
Условие:
- Элемент содержит атрибут: data-filter
  ИЛИ
- Элемент имеет класс: filter
  ИЛИ
- Родительский элемент содержит атрибут: data-filter
```

#### Пример настройки переменной для получения названия фильтра:

```
Тип переменной: JavaScript переменная
Код:
function() {
  var element = {{Click Element}};
  return element.getAttribute('data-filter') || 
         element.getAttribute('data-name') || 
         element.textContent.trim() || 
         'unknown';
}
```

### Шаг 3: Настройка Custom Dimensions в Matomo

1. Перейдите в **Настройки** → **Веб-сайты** → выберите `athletic-store.ru`
2. Перейдите в **Custom Dimensions**
3. Создайте следующие измерения:

| ID | Имя | Область действия |
|----|-----|-----------------|
| 1 | Screen Resolution | Посещение |
| 2 | Device Model | Посещение |
| 3 | Connection Type | Посещение |
| 4 | App Version | Посещение |

### Шаг 4: Публикация контейнера

1. После настройки всех тегов и триггеров
2. Нажмите **Опубликовать** в левом меню
3. Выберите версию и опубликуйте изменения

## Настройка в Android приложении

### 1. Конфигурация в `strings.xml`

Убедитесь, что в `app/src/main/res/values/strings.xml` указаны правильные значения:

```xml
<string name="matomo_url">https://matomo.private-analytic-tools.com</string>
<string name="matomo_container_id">HNSAYDRE</string>
<string name="matomo_site_id">2</string>
```

**Важно**: Замените `HNSAYDRE` на ваш реальный Container ID из Matomo Tag Manager.

### 2. Структура проекта

Созданы следующие файлы:

- `MatomoTagManagerIntegration.kt` - основной класс интеграции
- `DeviceInfoHelper.kt` - утилита для получения данных устройства
- `HybridWebView.kt` - обновлен для поддержки Matomo

### 3. Как это работает

1. При загрузке страницы в WebView автоматически инжектируется скрипт Matomo Tag Manager
2. Скрипт загружает контейнер из Matomo сервера
3. После загрузки контейнера инициализируется Matomo с кастомными данными
4. Настраивается автоматическое отслеживание событий через делегирование
5. Все события отправляются в Matomo через Tag Manager

## Тестирование

### 1. Проверка загрузки контейнера

1. Откройте приложение
2. Откройте DevTools в WebView (если доступно) или используйте `console.log`
сОткройте приложение и выполните действия:
   - Кликните на фильтр
   - Кликните на кнопку поиска
   - Измените значение в форме
3. В режиме отладки вы должны увидеть срабатывание тегов

### 3. Проверка данных в Matomo

1. Перейдите в **Отчеты** → **В реальном времени**
2. Выполните действия в приложении
3. Проверьте появление посещений в реальном времени

### 4. Проверка Custom Dimensions

1. Перейдите в **Отчеты** → **Посетители** → **Custom Dimensions**
2. Проверьте наличие данных в измерениях:
   - Screen Resolution
   - Device Model
   - Connection Type
   - App Version

## Ручное отслеживание событий из JavaScript

Если нужно отследить кастомное событие из кода сайта, используйте:

```javascript
// Простое событие
window.trackMatomoEvent('Category', 'Action', 'Name', 'Value');

// Пример: клик по кнопке "Купить"
window.trackMatomoEvent('Ecommerce', 'Click', 'Buy Button', 'product_123');

// Пример: добавление в корзину
window.trackMatomoEvent('Ecommerce', 'Add', 'Cart', 'product_456');
```

## Настройка событий для конкретного проекта

### Пример: Отслеживание клика по кнопке "САЙТЕ"

1. В Matomo Tag Manager создайте новый тег:
   - **Имя**: `Matomo Аналитика - клик по кнопке САЙТЕ`
   - **Тип**: `Matomo Аналитика`
   - **Тип отслеживания**: `Событие`
   - **Категория**: `Button`
   - **Действие**: `Click`
   - **Имя**: `САЙТЕ`

2. Создайте триггер:
   - **Тип**: `Клик на любой элемент`
   - **Условие**: 
     - Текст элемента содержит "САЙТЕ"
     ИЛИ
     - ID элемента содержит "site"
     ИЛИ
     - Класс элемента содержит "site-button"

3. Опубликуйте изменения

### Пример: Отслеживание поиска

Если на сайте есть поиск, можно настроить отдельный тег:

1. Создайте тег для события поиска
2. Триггер: клик на кнопку поиска или отправка формы поиска
3. Переменная: получить значение из поля поиска

## Устранение проблем

### Контейнер не загружается

1. Проверьте правильность `matomo_url` и `matomo_container_id` в `strings.xml`
2. Проверьте доступность Matomo сервера
3. Проверьте консоль WebView на наличие ошибок JavaScript

### События не отслеживаются

1. Убедитесь, что теги опубликованы в Matomo Tag Manager
2. Проверьте условия триггеров
3. Используйте режим отладки в Matomo Tag Manager
4. Проверьте консоль на наличие ошибок

### Custom Dimensions не отображаются

1. Убедитесь, что Custom Dimensions созданы в настройках сайта
2. Проверьте правильность ID измерений (1, 2, 3, 4)
3. Подождите несколько минут для обновления данных

## Дополнительные возможности

### Отслеживание переходов между страницами в SPA

Код автоматически отслеживает изменения URL в SPA приложениях через перехват `pushState` и `replaceState`.

### Отслеживание скролла

Можно добавить отслеживание скролла, создав тег с триггером события скролла.

### Отслеживание времени на странице

Matomo автоматически отслеживает время на странице, если настроено в тегах.

## Контакты и поддержка

Для вопросов по настройке Matomo Tag Manager обращайтесь к администратору Matomo.

Для вопросов по интеграции в Android приложение - к разработчику приложения.

---

**Дата создания**: 2025-12-25
**Версия**: 1.0







